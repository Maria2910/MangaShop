<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Корзина</title>
  <link rel="stylesheet" th:href="@{/css/cart.css}">
  <link rel="stylesheet" th:href="@{/css/header-footer.css}">
  <style>
    /* Стили для модального окна */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
    }

    .close {
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
<!-- Хэдер -->
<header th:insert="~{fragments/header}"></header>

<!-- Основной контент -->
<main class="cart-container">
  <div class="cart-header">
    <h1>Корзина покупок</h1>
    <a th:href="@{/}" class="back-link">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M19 12H5M12 19l-7-7 7-7"></path>
      </svg>
      На главную
    </a>
  </div>

  <!-- Пустая корзина -->
  <div th:if="${#lists.isEmpty(cartItems)}" class="empty-cart">
    <div class="empty-cart-icon">
      <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
    </div>
    <h2>Корзина пуста</h2>
    <p>Добавьте товары из каталога манги</p>
    <a th:href="@{/}" class="browse-btn">Перейти к покупкам</a>
  </div>

  <!-- Корзина с товарами -->
  <div th:unless="${#lists.isEmpty(cartItems)}" class="cart-content">
    <!-- Список товаров -->
    <div class="cart-items">
      <div th:each="item : ${cartItems}" class="cart-item">
        <div class="item-image">
          <img th:src="@{${item.manga.imageUrl}}" th:alt="${item.manga.title}">
        </div>

        <div class="item-details">
          <h3 th:text="${item.manga.title}"></h3>
          <p class="item-author" th:text="${item.manga.author}"></p>
          <p class="item-price" th:text="${#numbers.formatDecimal(item.price, 0, 2)} + ' $'"></p>
        </div>

        <div class="item-quantity">
          <form th:action="@{/cart/update/__${item.id}__}" method="post" class="quantity-form">
            <div class="quantity-controls">
              <button type="button" class="quantity-btn decrease"
                      onclick="updateQuantity(this, -1)" title="Уменьшить">
                -
              </button>

              <input type="number" name="quantity" th:value="${item.quantity}"
                     min="1" th:max="${item.manga.stockQuantity}"
                     class="quantity-input" onchange="this.form.submit()">

              <button type="button" class="quantity-btn increase"
                      onclick="updateQuantity(this, 1)" title="Увеличить">
                +
              </button>
            </div>
          </form>
        </div>

        <div class="item-total">
          <span th:text="${#numbers.formatDecimal(item.price * item.quantity, 0, 2)} + ' $'"></span>
        </div>

        <div class="item-actions">
          <form th:action="@{/cart/remove/__${item.id}__}" method="post">
            <button type="submit" class="remove-btn" title="Удалить из корзины">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M18 6L6 18M6 6l12 12"></path>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Итоговая сумма -->
    <div class="cart-summary">
      <div class="summary-card">
        <h3>Итоговая сумма</h3>

        <div class="summary-row">
          <span>Товаров:</span>
          <span th:text="${cartItemsCount} + ' шт.'"></span>
        </div>

        <div class="summary-row total">
          <span>Общая сумма:</span>
          <span th:text="${#numbers.formatDecimal(cartTotal, 0, 2)} + ' $'"></span>
        </div>

        <div class="summary-actions">
          <form th:action="@{/cart/clear}" method="post">
            <button type="submit" class="clear-btn">
              Очистить корзину
            </button>
          </form>

          <button class="checkout-btn">
            Оформить заказ
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Футер -->
<footer th:insert="~{fragments/footer}"></footer>

<!-- Модальное окно оформления заказа -->
<div id="orderModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Оформление заказа</h2>
      <span class="close">&times;</span>
    </div>

    <form th:action="@{/order/create}" method="post" class="order-form" th:object="${orderRequest}">
      <div class="form-group">
        <label for="customerName">ФИО *</label>
        <input type="text" id="customerName" name="customerName" required
               th:field="*{customerName}"
               th:value="${user.firstName != 'null' ? user.firstName : ''} + ' ' + ${user.lastName != 'null' ? user.lastName : ''}">
      </div>

      <div class="form-group">
        <label for="customerEmail">Email *</label>
        <input type="email" id="customerEmail" name="customerEmail" required
               th:field="*{customerEmail}"
               th:value="${user.email != 'null' ? user.email : ''}">
      </div>

      <div class="form-group">
        <label for="customerPhone">Телефон *</label>
        <input type="tel" id="customerPhone" name="customerPhone" required
               th:field="*{customerPhone}"
               th:value="${user.phone != 'null' ? user.phone : ''}">
      </div>

      <div class="form-group">
        <label for="shippingAddress">Адрес доставки *</label>
        <textarea id="shippingAddress" name="shippingAddress" required
                  rows="3" placeholder="Город, улица, дом, квартира"
                  th:field="*{shippingAddress}"></textarea>
      </div>

      <div class="form-group">
        <label for="paymentMethod">Способ оплаты *</label>
        <select id="paymentMethod" name="paymentMethod" required th:field="*{paymentMethod}">
          <option value="">Выберите способ оплаты</option>
          <option value="CARD">Банковская карта</option>
          <option value="SBERPAY">СберПэй</option>
          <option value="QIWI">QIWI</option>
          <option value="YANDEX_MONEY">ЮMoney</option>
          <option value="CASH">Наличные при получении</option>
        </select>
      </div>

      <div class="form-summary">
        <div class="summary-row">
          <span>Товаров:</span>
          <span th:text="${cartItemsCount} + ' шт.'"></span>
        </div>
        <div class="summary-row total">
          <span>К оплате:</span>
          <span th:text="${#numbers.formatDecimal(cartTotal, 0, 2)} + ' $'"></span>
        </div>
      </div>

      <button type="submit" class="submit-order-btn">
        Подтвердить заказ
      </button>
    </form>
  </div>
</div>

<!-- JavaScript -->
<script>
  function updateQuantity(button, change) {
    const form = button.closest('.quantity-form');
    const input = form.querySelector('.quantity-input');
    let quantity = parseInt(input.value) || 1;

    quantity += change;

    const max = parseInt(input.getAttribute('max')) || Infinity;
    const min = parseInt(input.getAttribute('min')) || 1;

    if (quantity >= min && quantity <= max) {
      input.value = quantity;
      form.submit();
    }
  }

  // Обработчики для модального окна
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('orderModal');
    const checkoutBtn = document.querySelector('.checkout-btn');
    const closeBtn = document.querySelector('.close');

    if (checkoutBtn && modal) {
      checkoutBtn.addEventListener('click', function() {
        modal.style.display = 'block';
      });
    }

    if (closeBtn && modal) {
      closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });
    }

    window.addEventListener('click', function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    });

    // Валидация формы
    const orderForm = document.querySelector('.order-form');
    if (orderForm) {
      orderForm.addEventListener('submit', function(e) {
        const inputs = this.querySelectorAll('input[required], select[required], textarea[required]');
        let valid = true;

        inputs.forEach(input => {
          if (!input.value.trim()) {
            input.style.borderColor = '#e53e3e';
            valid = false;
          } else {
            input.style.borderColor = '';
          }
        });

        if (!valid) {
          e.preventDefault();
          alert('Пожалуйста, заполните все обязательные поля');
        }
      });
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Обработка null значений в форме
    const customerNameInput = document.getElementById('customerName');
    if (customerNameInput && customerNameInput.value.includes('null')) {
      customerNameInput.value = '';
      customerNameInput.placeholder = 'Введите ваше ФИО';
      customerNameInput.style.borderColor = '#fed7d7';
      customerNameInput.style.backgroundColor = '#fff5f5';
    }

    // Очистка других полей с null
    const inputs = document.querySelectorAll('input[value*="null"]');
    inputs.forEach(input => {
      if (input.value.includes('null')) {
        input.value = '';
        input.style.borderColor = '#fed7d7';
        input.style.backgroundColor = '#fff5f5';
      }
    });

    // Восстановление нормального стиля при фокусе
    const formInputs = document.querySelectorAll('.form-group input, .form-group textarea');
    formInputs.forEach(input => {
      input.addEventListener('focus', function() {
        this.style.borderColor = '#667eea';
        this.style.backgroundColor = 'white';
      });

      input.addEventListener('blur', function() {
        if (this.value === '') {
          this.style.borderColor = '#fed7d7';
          this.style.backgroundColor = '#fff5f5';
        } else {
          this.style.borderColor = '#e9ecef';
          this.style.backgroundColor = 'white';
        }
      });
    });
  });
</script>
</body>
</html>