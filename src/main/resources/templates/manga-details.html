<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${manga.title}">Детали манги</title>
  <link rel="stylesheet" th:href="@{/css/manga-details.css}">
  <link rel="stylesheet" th:href="@{/css/header-footer.css}">
</head>
<body>
<!-- Хэдер -->
<header th:insert="~{fragments/header}"></header>

<!-- Основной контент -->
<main class="container">
  <a href="/" class="back-link">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M19 12H5M12 19l-7-7 7-7"></path>
    </svg>
    На главную
  </a>

  <div class="manga-detail">
    <!-- Левая колонка - картинка и форма -->
    <div class="left-column">
      <!-- Картинка -->
      <div class="manga-image">
        <img th:src="@{${manga.imageUrl}}" th:alt="${manga.title}">
      </div>

      <!-- Форма добавления в корзину -->
      <div class="add-to-cart-form">
        <h3>Добавить в корзину</h3>

        <form th:action="@{/cart/add/__${manga.id}__}" method="post">
          <div class="quantity-selector">
            <label for="quantity">Количество:</label>
            <input type="number" id="quantity" name="quantity" value="1" min="1"
                   th:max="${manga.stockQuantity}" class="quantity-input">
          </div>

          <button type="submit" class="add-to-cart-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            Добавить в корзину
          </button>
        </form>

        <!-- Сообщение об успехе -->
        <div th:if="${param.added}" class="success-message">
          ✅ Товар успешно добавлен в корзину!
        </div>
      </div>
    </div>

    <!-- Правая колонка - информация -->
    <div class="manga-info">
      <h1 th:text="${manga.title}"></h1>

      <!-- Список деталей -->
      <ul class="details-list">
        <li class="detail-item">
          <strong>Автор:</strong>
          <span th:text="${manga.author}"></span>
        </li>

        <li class="detail-item">
          <strong>Художник:</strong>
          <span th:text="${manga.artist}"></span>
        </li>

        <li class="detail-item">
          <strong>Дата выхода:</strong>
          <span th:text="${manga.releaseDate != null} ? ${#temporals.format(manga.releaseDate, 'dd.MM.yyyy')} : 'Не указана'"></span>
        </li>

        <li class="detail-item">
          <strong>Цена:</strong>
          <span th:text="${#numbers.formatDecimal(manga.price, 0, 2)} + ' $'"></span>
        </li>

        <li class="detail-item">
          <strong>В наличии:</strong>
          <span th:text="${manga.stockQuantity} + ' шт.'"></span>
        </li>
      </ul>

      <!-- Описание -->
      <div class="description">
        <h3>Описание</h3>
        <p th:text="${manga.description}"></p>
      </div>
    </div>
  </div>

  <!-- Секция отзывов -->
  <section class="reviews-section">
    <h2>Отзывы</h2>

    <!-- Средняя оценка -->
    <div class="average-rating" th:if="${averageRating > 0}">
      <h3>Средняя оценка:
        <span th:text="${#numbers.formatDecimal(averageRating, 1, 1)}"></span>
        <span> ★</span>
      </h3>
      <p>На основе <span th:text="${reviews.size()}"></span> отзывов</p>
    </div>

    <!-- Форма добавления отзыва -->
    <div class="add-review" th:unless="${hasReviewed}">
      <h3>Оставить отзыв</h3>
      <form th:action="@{/manga/__${manga.id}__/reviews}" method="post" th:object="${reviewRequest}">
        <div class="form-group">
          <label>Оценка:</label>
          <div class="star-rating">
            <input type="radio" id="star5" name="rating" value="5" th:field="*{rating}">
            <label for="star5">★</label>
            <input type="radio" id="star4" name="rating" value="4" th:field="*{rating}">
            <label for="star4">★</label>
            <input type="radio" id="star3" name="rating" value="3" th:field="*{rating}">
            <label for="star3">★</label>
            <input type="radio" id="star2" name="rating" value="2" th:field="*{rating}">
            <label for="star2">★</label>
            <input type="radio" id="star1" name="rating" value="1" th:field="*{rating}">
            <label for="star1">★</label>
          </div>
        </div>

        <div class="form-group">
          <label for="comment">Ваш отзыв:</label>
          <textarea id="comment" name="comment" th:field="*{comment}"
                    placeholder="Поделитесь вашими впечатлениями..."
                    rows="3" required></textarea>
        </div>

        <button type="submit" class="submit-review-btn">Отправить отзыв</button>
      </form>
    </div>

    <!-- Список отзывов -->
    <div class="reviews-list" th:if="${not #lists.isEmpty(reviews)}">
      <h3>Отзывы пользователей</h3>
      <div th:each="review : ${reviews}" class="review-card">
        <div class="review-header">
          <span class="review-author" th:text="${review.user.username}"></span>
          <span class="review-date"
                th:text="${#temporals.format(review.createdAt, 'dd.MM.yyyy HH:mm')}"></span>
        </div>

        <div class="review-rating">
          <div class="stars" th:attr="data-rating=${review.rating}">
            <!-- Звезды будут отрисованы через JavaScript -->
          </div>
        </div>

        <div class="review-comment">
          <p th:text="${review.comment}"></p>
        </div>
      </div>
    </div>

    <div th:if="${#lists.isEmpty(reviews)}" class="no-reviews">
      <p>Пока нет отзывов. Будьте первым!</p>
    </div>
  </section>
</main>

<!-- Футер -->
<footer th:insert="~{fragments/footer}"></footer>

<!-- Подключаем JS файл -->
<script th:src="@{/js/manga-details.js}"></script>

</body>
</html>